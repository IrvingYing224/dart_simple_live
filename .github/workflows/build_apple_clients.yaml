name: build-apple-clients

on:
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘ç¼–è¯‘
  push:
    tags:
      - "v*" # å½“ä½ æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è‡ªåŠ¨è§¦å‘

jobs:
  build-apple:
    runs-on: macos-latest

    permissions:
      contents: write

    steps:
      # 1. ç­¾å‡ºä»£ç  (é»˜è®¤ç­¾å‡ºè§¦å‘è¯¥ Action çš„åˆ†æ”¯)
      - uses: actions/checkout@v4

      # 2. è®¾ç½® Flutter ç¯å¢ƒ
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.x" # å»ºè®®æ ¹æ®ä½ é¡¹ç›®çš„å…·ä½“ç‰ˆæœ¬å¾®è°ƒï¼Œæˆ–ä¿æŒ 3.38.x
          cache: true

      # 3. å¼€å¯ macOS Desktop æ”¯æŒ
      - name: Enable Flutter Desktop
        run: flutter config --enable-macos-desktop

      # 4. è·å–ä¾èµ–
      - name: Restore packages
        run: |
          cd simple_live_app
          flutter pub get

      # 5. å®‰è£… macOS æ‰“åŒ…å·¥å…· (appdmg & flutter_distributor)
      - name: Install Build Tools
        run: |
          npm install -g appdmg
          dart pub global activate flutter_distributor

      # 6. ç¼–è¯‘ iOS (æ— ç­¾åæ¨¡å¼)
      - name: Build IPA (No Sign)
        run: |
          cd simple_live_app
          flutter build ios --release --no-codesign
          mkdir -p build/ios/iphoneos/Payload
          cp -R build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/Runner.app
          cd build/ios/iphoneos/
          zip -q -r ios_no_sign.ipa Payload

      # 7. ç¼–è¯‘ MacOS (ç”Ÿæˆ DMG å’Œ ZIP)
      - name: Build MacOS
        run: |
          cd simple_live_app
          # ç¡®ä¿ä½ çš„ç¯å¢ƒè·¯å¾„åŒ…å« pub global çš„ bin ç›®å½•
          export PATH="$PATH":"$HOME/.pub-cache/bin"
          flutter_distributor package --platform macos --targets dmg,zip --skip-clean

      # 8. ä¸Šä¼ äº§ç‰©åˆ° Artifacts (å¯åœ¨ GitHub Actions ç•Œé¢ä¸‹è½½)
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apple-clients
          path: |
            simple_live_app/build/ios/iphoneos/ios_no_sign.ipa
            simple_live_app/build/dist/*/*.dmg
            simple_live_app/build/dist/*/*.zip

      - run: echo "ğŸ Job status is ${{ job.status }}."
